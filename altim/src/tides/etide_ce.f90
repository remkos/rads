module tides_ce
contains

!*etide_ce -- Solid Earth Tide, Cartwright and Edden
!+
function etide_ce (mjd, lat, lon)
use typesizes
use tides_aux
real(eightbytereal), intent(in) :: mjd, lat, lon
real(eightbytereal) :: etide_ce
!
! This function returns the solid earth tide elevation at a specified
! epoch (MJD) and location (LAT and LON).
! The elevation is based on the tidal potential according to
! Cartwright and Tayler (Geophys. J R. Astr Soc, 1971, 23, 45-74)
! as corrected by Cartwright and Edden (Geophys. J. R. Astr Soc., 1973,
! 33, 253-264).
!
! This implementation is conform the T/P algorithm G1062 for solid earth tides.
! Although, some changes have been made to increase precision.
!
! The earth tide computed does not include the permanent tide. It can be
! activated by setting the parameter "permanent" to .true. in the code.
!
! Input arguments:
!  mjd      : Modified Julian Date
!  lat      : Geodetic latitude in degrees
!  lon      : Geodetic longitude in degrees
!
! Function output:
!  etide_ce : Solid earth tide elevation in meters
!-
! $Log: etide_ce.f90,v $
! Revision 1.13  2017/10/12 09:17:55  rads
! - Add generic mean_longtitudes routine
!
! Revision 1.12  2014/02/08 16:39:01  rads
! - Replaced cmplx by dcmplx to avoid loss of precision
!
! Revision 1.11  2011/05/24 14:48:35  rads
! - Created module "tides"
!
! Revision 1.10  2010/08/01 19:13:06  rads
! - Minor speed up
!
! Revision 1.9  2008/05/22 19:32:37  rads
! - Removed unused variables
!
! Revision 1.8  2008/05/21 16:21:11  rads
! - Astronomical angles update to J2000 (same as gottide.f90)
!
! Revision 1.7  2008/05/20 18:09:46  rads
! - Converted from Fortran 77 to Fortran 90
!
! Revision 1.6  2008/03/17 17:07:20  rads
! - Avoid using EXP(CMPLX(,)). Use CMPLX(COS(),SIN()) instead.
!
! Revision 1.5  2008/01/12 21:10:56  rads
! - Removed DG output from TIDPOT
! - Removed multiplication by GRAV in TIDPOT since ETIDE_CE had again to
!   divide by it.
! - Fixed bug in TIDPOT that made permanent tide not work properly when
!   requested.
! - None of these changes has any effect on the output of ETIDE_CE
!
! Revision 1.4  2005/10/27 20:13:22  rads
! - Change in manual only
!
! Revision 1.3  2005/05/31 20:48:43  rads
! - Optimization of TIDPOL routine by changing computation to complex
!
!  2-May-2003 - Improved precision in TIDPOT
! 17-Jan-2002 - Extended SAVE statement in TIDPOT to all variables.
!  5-Feb-1997 - Created by Remko Scharroo from the T/P algorithm G1062.
!-----------------------------------------------------------------------
real(eightbytereal) :: v2,v3,sinth,costh,w20,w21,w22,w30,w31,w32,w33,shpn(6)
real(eightbytereal), parameter :: rh2=0.609d0,rh3=0.291d0 ! Love numbers
logical, parameter :: permanent=.false.	! Switch for selecting to include permanent tide

! Local variables

integer(fourbyteint) ::	i,j
complex(eightbytereal) :: cvect(-5:5,6)
real(eightbytereal), parameter :: pi=4d0*atan(1d0),twopi=2d0*pi,rad=pi/180d0,grav=1d-5,d1960=37076.5d0, &
	cl20=sqrt(5d0/4d0/pi),cl21=sqrt(5d0/24d0/pi),cl22=sqrt(5d0/96d0/pi), &
	cl30=sqrt(7d0/4d0/pi),cl31=sqrt(7d0/48d0/pi),cl32=sqrt(7d0/480d0/pi),cl33=sqrt(7d0/2880d0/pi)

integer(fourbyteint), parameter :: cs(486) = (/ &
 -31458,  2793,   -28,     4,    -4,  -492,    26,     5, &
      2,   -32, -3098,   -12,    77,    17,  -181,     3, &
     -7,     2,   -29,     0,     2,     7,    48,  -673, &
     44,     0,   -22,    20,     5,    -3,   231, -3518, &
    229,   188,    77,    21,    18,    49,    24,     4, &
      2,   -11,   -38,     2,   -42,  -583,    38,     4, &
     -4,     3,     6,   -20,    -4,    15,  -288,    19, &
  -6661, -2762,  -258,     6,     3,    23,     6,    20, &
      8,     3,    -2,   -17,    -7,   -11,    -4,    -9, &
    -92,     6,  -242,  -100,    -9,   -13,    -4,     7, &
      3,     3,   -23,     4,     4, -1276,  -529,   -52, &
      5,     2,    11,     4,    -8,    -6,    -3,   -14, &
     -6,   -11,  -204,   -84,    -8,    -3,     3,  -169, &
    -70,    -7,   -14,   -75,     4,   -37,  -194,   -15, &
     -7,   -37,    -4,     9,     4,     2,  -125,  -664, &
     11,     7,   -10,     4,  -151,  -802,     7,   -10, &
    -54,    -5,   -24,     8,    -3,     4,    16,     7, &
     42,     4,    19,    29,    -4,  -947, -5019,    14, &
      9,     5,    27,    -8,   -46,     5,  -180,  -954, &
     55,   -17,    -8,   -44,     4,    12,    11,    14, &
     79,    11,    90,    -4,   152, -4945,-26216,    -5, &
    170,    28,    -8,   -76,    15,   -10,   343,   -75, &
     -5,    23,     6,     9,    44,   194,    -4,   -10, &
    -12,   137,   741,   -59,  2062,   414,   -11,   -12, &
     13,   -11,   394,    87,    17,     4,   -29,     6, &
   -713,   -10,   137,-12201,     5,    18,     4,   102, &
    289,    -8,     7,     5,  -623, 31484,  4270,  -108, &
    293,     5,    18,     5,     7,   525,   -20,   -10, &
     31,    17,    12,   -12,   395,    78,    12,   -12, &
    -60,  2062,   409,    -5,   -32,   -20,   -12,   -11, &
     -8,    -6,     6,    23,     4,    11,   342,    67, &
     -7,    -4,   169,    34,  1129,   723,   151,    10, &
     -4,    10,     4,    54,    11,    41,    26,     5, &
     13,   216,   138,    29,    19,    78,     6,    48, &
      6,    -7,   180,    -9,     4,   -17,   467,    36, &
     -3,    90,    10,    -6,   -22,   -10,   -60,  1601, &
    -27,   -17,    25,   -72,  1932,    -4,    -5,   130, &
     59,     5,     5,   -10,   -39,     3,  -102,   -47, &
      7,    10,  -451, 12099,   -22,   -65,    -4,   113, &
    -86,  2298,    10,    -8,    -4,   106,    -8,   -28, &
      7,  -190,     5,  -218,     9,    33, -2358, 63194, &
     37,    13,    -4,   192,   -36,    72,   -36,    12, &
      5,   -22,    21,  -466,    -7,    11,    66, -1786, &
     -8,   447,   197,    28,    86,    41,     5,    70, &
   1718,    66, 29402,     4,  -246,    62,    -4,  -102, &
   7993,  2383,   259,    63,     4,    53,     4,     6, &
      4,    86,    37,     4,    -9,   447,   195,    22, &
     -3,     5,    74,    32,     3,    37,    16,   117, &
    101,    33,     5,   -21,    -4,     4,    19,  -375, &
    -59,     5,   -12,   -61,   -10,   -10,    -7,   -30, &
    -19,    -4,    -8,    -5,    -6,    -6,   -14,   -35, &
     -7,    -4,   -50,  -128,    -8,   -11,     7,    10, &
    -65,     9,   -13,    59,  -399,    52,    -4,     3, &
    -22,     3,    -8,    -3,    -5,     5,  -146,   -59, &
     -5,    -5,   -24,   -10,    -4,    -5,    -5,    -6, &
    -18,    -3,   -18,   -18,  -107,    -3,   -20,     3, &
    -66,  -389,     7,    10,     5,     4,    22,    -3, &
     59,    11,    11,   -21,   359,    68,     4,    19, &
      4,     4,    33,    21,     4,     5,    37,    37, &
    -12,   210,    39,    -5,   -43,   765,   -11,   -43, &
     16,     7,    -4,   100,    43,     5 /)
integer(fourbyteint), parameter :: kmax(6)=(/ 3, 4, 5, 4, 3, 2/)
integer(fourbyteint), parameter :: k(486,6)=reshape((/ &
(0,i=1,106),(1,i=1,162),(2,i=1,119),(0,i=1,17),(1,i=1,35), & ! k(:,1)
(2,i=1,31),(3,i=1,16), &
(0,i=1,17),(1,i=1,24),(2,i=1,25),(3,i=1,26),(4,i=1,14), &    ! k(:,2)
(-4,i=1,9),(-3,i=1,18),(-2,i=1,26),(-1,i=1,20),(0,i=1,19), &
(1,i=1,27),(2,i=1,17),(3,i=1,15),(4,i=1,11),(-4,i=1,5), &
(-3,i=1,10),(-2,i=1,16),(-1,i=1,19),(0,i=1,19),(1,i=1,14), &
(2,i=1,15),(3,i=1,11),(4,i=1,10),0,0,1,1,1,1,1,2,2,2,3,3,3,3,3, &
 4, 4,-4,-4,-3,-3,-3,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1, 0, 0, 0, 1, 1, &
 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 4, 4, 4,-4,-3,-3,-3,-2,-2,-2, &
-2,-1,-1,-1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, &
 3, 4,-2,-2,-1,-1,-1, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, &
 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 4,-3,-3,-3,-2,-2, & ! k(:,3)
-2,-2,-2,-1,-1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3,-4,-3,-3, &
-2,-2,-2,-2,-1,-1,-1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 2, &
-5,-4,-3,-3,-3,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1, 0, 0, 0, 0, 0, 0, &
 0, 0, 1, 1,-4,-4,-4,-3,-3,-2,-2,-2,-2,-1,-1, 0, 0, 0, 0, 0, 1, 2, &
 2, 3, 4, 4, 5,-1, 0, 0, 0, 0, 1, 1, 1, 2, 2, 2, 2, 3, 3, 4, 4, 4, &
 4,-2,-2,-1,-1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, &
 3, 3, 3, 4,-2,-2,-2,-1,-1,-1, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 2, 2, &
 2, 3, 4,-3,-2,-2,-1,-1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 2, 3, 3, &
-4,-3,-3,-2,-2,-2,-2,-2,-2,-1,-1,-1, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, &
 2, 2, 2, 2, 3,-3,-2,-2,-2,-2,-1,-1, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, &
-4,-3,-3,-2,-2,-2,-1, 0, 0, 0, 0, 0, 0, 0, 1,-4,-3,-2,-2,-2,-2,-2, &
 0, 0, 0, 0, 0, 2, 3, 4, 5, 0, 0, 1, 1, 2, 2, 3, 4, 4, 5,-2,-1, 0, &
 0, 0, 1, 1, 1, 2, 2, 3, 3, 3, 4, 4, 5,-2,-2,-1,-1, 0, 0, 0, 0, 0, &
 1, 1, 1, 1, 2, 2, 2, 2, 3, 3,-3,-2,-2,-2,-1,-1,-1, 0, 0, 0, 0, 0, &
 1, 1, 2, 2, 2, 2, 3,-3,-2,-2,-1,-1, 0, 0, 0, 0, 0, 0, 2, 2, 2,-4, &
-3,-2,-2,-2,-1,-1,-1, 0, 0, 0, 0, 1, 2, 2,-3,-2,-2,-2,-2,-2, 0, 0, &
 0, 0, 0,-3,-2,-2,-2, 0, 0, 0, 0, 0, 0, 0, 2,-2, 0, 0, 0, 0,-2, 0, &
 0,-2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, &
 2, 0, 0, 0,-2, 0, 0, 0, 0, 0,-2, 0, 0, 0, 0,-2, 0, 0,-2, 0, 0, 2, &
 0, 2, 2, 0, 0, 2, 2, 0, 0, 0, 0, 2,-2, 0, 0, 0, 0, 0, 2, 0, 0, 0, &
-2, 0, 0,-2, 0, 0, 0, 0, 0, 2, 0, 0, 2,-2, 0, 0,-2, 0, 0, 0, 0, 0, &
 0, 0, &
 0, 0, 0, 2, 0, 0, 0, 0,-2,-2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1,-1,-1, & ! k(:,4)
 1, 1, 1,-1,-1, 0, 1,-1,-1,-1,-1, 1, 1, 1,-1,-1,-1,-1,-1, 2, 0, 0, &
 0, 0, 0, 2,-2,-1, 0, 0, 0,-2,-2,-2, 0, 0, 0, 0,-2, 0, 0,-2,-2, 0, &
 1, 1,-1, 1, 1,-1,-1,-1, 1, 1, 1,-1,-1, 0, 0, 1,-3,-3,-3,-1,-1,-1, &
 1, 1,-1,-1, 0, 2, 2, 0, 0,-2, 0, 0, 0,-2, 0,-2,-2,-2, 3, 3, 1, 1, &
 1, 1,-1,-1,-1, 2, 0, 2, 2, 2, 0, 1, 2, 0, 0, 0, 2, 0, 0,-2,-2, 0, &
 0, 1, 3, 1, 1,-1,-1, 1, 0, 1, 1, 3,-1, 0, 0, 1, 1,-1,-1,-1, 1, 1, &
-1,-1, 1,-1, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2, 2, 0, 0,-2, 0, 0, 0, &
 0, 0,-2, 1, 1, 1, 0, 1,-1,-1,-1, 1, 1, 1, 1, 0, 1,-1,-1,-1,-1,-1, &
 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0,-2, 0, 0, 0, 0, 0, 0, 0,-2,-2, &
 0, 0, 0, 0, 0, 1,-1, 1, 1, 1,-1, 0,-1,-1,-1,-1, 1, 1, 1,-1,-1,-1, &
 2, 0, 0, 0, 0, 0, 0,-2,-2,-2, 0, 0, 0, 0, 0, 1,-1,-1,-1, 1, 1, 1, &
-3,-1,-1,-1, 4, 2, 2, 0, 0, 3, 3, 1, 3, 1, 1, 1,-1,-1,-1, 4, 2, 0, &
 2, 2, 0, 1, 2, 0, 0,-1, 0, 0,-2, 0,-2, 1, 3, 1, 1,-1, 1, 0, 1, 1, &
-1, 0, 1, 1,-1,-1, 1, 1,-1,-1, 2, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2, &
 0, 0,-2, 0, 0, 0, 0, 1, 1, 1,-1, 0,-1,-1, 1, 1, 1, 1,-1,-1,-1, 0, &
 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0, 1,-1,-1, 1, 1, 1,-1,-1, &
-1,-1, 1, 0, 0, 0, 0,-2,-2, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0, 0, 1,-1, &
-1, 0,-2, 0, 0, 0,-1,-1, 2, 0, 1, 1,-1, 0, 0, 0, 2, 0,-1, 1, 1, 1, &
-1, 0, 0, 0, 1,-1,-1,-1, 1, 1, 0, 0, 0, 0, 0, 1,-1,-1, 0, 0, 0, 1, &
 2, 0, 0, 1, 1,-1,-1, 0, 0, 0, 2, 0, 1,-1,-1, 1, 1, 1,-1, 0, 0, 0, &
 1,-1,-1, 0, 0, 0, 0,-1, 2, 0, 1, 1,-1, 2, 0, 0, 1,-1, 1, 1, 0, 0, &
 0, 0, &
 0, 1, 2, 1,-1, 0, 0, 1,-1, 0, 0, 0, 1, 2, 0, 1, 0,-1, 0, 1,-2,-1, & ! k(:,5)
-1, 0, 1,-1, 0, 0, 0,-2,-1, 0, 1, 0, 1, 2, 0, 0, 1, 2, 0, 0, 0, 1, &
-1, 0, 1, 0, 0, 0, 0, 0, 1,-1, 0, 1, 0, 1, 2, 3, 0, 0, 1, 0, 1, 2, &
 0, 0, 0, 0, 1,-1, 0, 1, 0, 1, 2, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 2, &
 2, 3, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 2, 0, 0, 0, 1, 2,-1, 0, 0,-1, &
 0, 0,-1, 0, 0, 0,-2,-2,-1, 0, 0, 0, 0,-2,-1, 0, 0,-1, 0,-1, 0, 0, &
 1,-2, 0,-1, 0,-3,-2,-2, 0,-1, 0, 0, 0,-1, 0,-1, 0,-2,-1, 0, 0, 1, &
-1, 0, 0, 0,-2,-1, 0,-1, 0, 0,-2,-1, 0,-1, 0, 1,-1, 0, 0,-1, 0, 1, &
 2, 0, 0, 0,-1, 0, 0, 0,-2,-1, 0,-1, 0, 1, 2, 0, 0,-1, 0, 1, 0, 1, &
 0,-1, 0,-2,-1, 0, 0, 0, 1, 0, 0, 1,-1,-2,-1, 0, 1, 2, 0, 1, 0, 1, &
 0, 0, 1, 2, 0, 0,-1,-1, 0, 1, 0, 0,-1, 0, 1, 2, 0, 1, 2, 0, 0, 1, &
 0, 0, 1,-1, 0, 1, 0,-1, 0, 1, 0, 1, 2, 3, 0, 0, 0, 0, 1, 0, 1, 2, &
 0, 0, 1, 2, 0, 0, 0, 0, 0,-1, 0, 0, 0,-1, 0, 0,-1, 0, 0, 0, 0,-2, &
-1, 0, 0, 0, 0,-1, 0, 0,-1, 0, 0, 0, 0,-2, 0,-1, 0,-2,-2, 0,-1, 0, &
 0, 0,-1, 0,-1, 0, 0, 1,-1, 0, 0,-2,-1, 0,-1, 0, 0,-2,-1, 0, 0, 1, &
-1, 0, 0, 0, 1, 2, 0, 0,-1, 0, 0, 0,-1, 0,-1, 0, 1, 2, 0, 1, 2, 0, &
 0,-1, 0, 0, 0, 0, 1,-1, 0, 1, 2, 0, 0, 0, 0,-1, 0, 0, 1, 2,-1, 0, &
 1, 2, 0, 0, 0, 1, 2, 0, 1, 0, 1, 2, 3, 0, 0, 0,-1, 0, 1, 2, 0, 0, &
 1, 0, 0, 0, 1, 2, 0, 1, 0, 0,-1, 0, 0,-2,-1, 0, 0, 0, 0,-1, 0, 0, &
 0,-1, 0, 1, 0,-1, 0, 1, 0, 1, 0,-1, 0, 1, 2, 0, 0, 1, 0, 0, 1, 0, &
 0,-1, 0,-1, 0,-1, 0,-2,-1, 0, 0, 0, 0,-1, 0,-1, 0, 1, 0,-1, 0, 1, &
 0, 0, 1, 0, 0, 1, 2, 0, 0, 0,-1, 0, 0, 0,-1, 0, 0, 0, 0, 1,-1, 0, &
 1, 2, &
 0, 0, 0, 0,-1,-1, 1,-1, 0, 0, 0,-2, 0, 0,-1,-1,-2, 1, 1, 1, 0, 0, & ! k(:,6)
 0, 0, 0, 1, 1, 0,-1, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 0,-1, 0, 1, 1, &
 0, 0, 0, 0, 1, 0,-1, 1, 1, 0, 0, 0, 0, 0, 0, 0,-1,-1,-1, 0, 0, 0, &
 1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0,-1, 0,-1, 1, 0, 0, 0, &
 0, 0,-1,-1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0, 0, 1, 0, &
 0,-1, 0, 0,-1, 1, 0, 0, 0, 0, 1, 0,-1, 0, 0, 0, 0,-1,-1, 0, 0, 0, &
 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0,-1,-1, 0, 0, 0, 0, 0, &
-1,-1,-1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0,-1,-1, 0, 0, 0, 0, &
 0,-1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, 0,-1,-1, &
 2, 1, 1, 0, 0, 0, 2, 0, 0,-1, 1, 1, 0, 0, 0, 0, 0, 0,-1,-1, 0, 0, &
-2, 0, 0, 0,-1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,-1, 0, 0, &
 0, 1, 1, 0, 0, 0,-1, 0, 0, 0, 0, 0, 0, 0,-1, 0, 1, 0, 0, 0, 0, 0, &
 0, 0, 0, 0, 0, 0,-1, 0,-1, 0, 0, 1,-1, 0, 0,-1, 0, 0,-1, 0, 1, 0, &
 0, 0, 1, 0,-1, 0, 0, 0,-1,-1, 0,-2,-1, 0, 0, 1, 1, 0, 0, 1, 0, 0, &
 1, 0,-1,-1, 0, 0, 0, 0,-1,-1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, &
-1,-1, 0, 0, 0, 0,-1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
 1, 0, 0, 0,-1, 1, 1, 0, 0, 0, 0,-1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, &
 0, 0, 1, (0, i=1,109) /), (/ 486,6 /))

! Start of executable code

sinth = sin(lat*rad)
costh = cos(lat*rad)

! Compute normalized Legendre functions (fully normalized)

w20 =  cl20 * (1.5d0*sinth**2 - .5d0)
w21 = -cl21 * 3d0*sinth*costh
w22 =  cl22 * 3d0*costh**2
w30 =  cl30 * (2.5d0*sinth**2 - 1.5d0)*sinth
w31 = -cl31 * 1.5d0*costh*(5d0*sinth**2 - 1d0)
w32 =  cl32 * 15d0*costh**2*sinth
w33 = -cl33 * 15d0*costh**3

! Compute all essential astronomical angles and (cos(i*sphn),sin(i*sphn)) complex pairs

call mean_longitudes (mjd - 46066d0, shpn(2), shpn(3), shpn(4), shpn(5), shpn(6))
shpn(1) = modulo(shpn(3) - shpn(2) + mjd * 360d0 + lon,360d0)
shpn = shpn * rad

do j=1,6
	cvect( 0,j) = 1d0
	cvect( 1,j) = dcmplx(cos(shpn(j)),sin(shpn(j)))
	cvect(-1,j) = dconjg(cvect(1,j))
	do i=2,kmax(j)
		cvect( i,j) = cvect(i-1,j)*cvect(1,j)
		cvect(-i,j) = dconjg(cvect(i,j))
	enddo
enddo

! Second order waves

v2 = vreal (2,106) * w20 + vimag (107,268) * w21 + vreal (269,387) * w22
if (permanent) v2 = v2 + cs(1) * w20

! Third order waves

v3 = vimag (388,404) * w30 + vreal (405,439) * w31 + vimag (440,470) * w32 + vreal (471,486) * w33

! Convert potential to Solid Earth Tide

etide_ce = (rh2*v2 + rh3*v3) * grav

contains

! Supporting routines

function vreal (i0, i1)
real(eightbytereal) :: vreal
integer(fourbyteint) :: i0,i1,i,j
complex(eightbytereal) :: value
vreal = 0d0
do i=i0,i1
	value = 1d0
	do j=1,6
		value = value * cvect(k(i,j),j)
	enddo
	vreal = vreal + cs(i) * dble(value)
enddo
end function vreal

function vimag (i0, i1)
real(eightbytereal) :: vimag
integer(fourbyteint) :: i0,i1,i,j
complex(eightbytereal) :: value
vimag = 0d0
do i=i0,i1
	value = 1d0
	do j=1,6
		value = value * cvect(k(i,j),j)
	enddo
	vimag = vimag + cs(i) * dimag(value)
enddo
end function vimag

end function etide_ce

end module tides_ce
